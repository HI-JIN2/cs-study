# 도커 최적화와 Compose (0207)

## 1. 멀티 스테이지 빌드 (Multi-Stage Build)

### 1) 개요
*   하나의 Dockerfile에 여러 개의 `FROM` 절을 사용하여, 빌드 환경과 실행 환경을 분리하는 기술.
*   **목적**: 최종 이미지 크기 최소화. 빌드 도구(Maven, Gradle, Compiler 등)는 최종 이미지에 포함시키지 않음.

### 2) 예시: Java (SpringBoot) 앱
```dockerfile
# 1단계: 빌드 (JDK 포함)
FROM openjdk:11-jdk AS builder
WORKDIR /app
COPY . .
RUN ./gradlew build

# 2단계: 실행 (JRE만 포함) - 경량화
FROM openjdk:11-jre-slim
WORKDIR /app
# 1단계(builder)에서 생성된 jar 파일만 복사
COPY --from=builder /app/build/libs/*.jar app.jar
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 3) 언어별 적용
*   **Go/C++**: 컴파일된 바이너리만 남기고, 소스 코드 및 컴파일러 제거.
*   **Node.js/React**: `npm install` 및 `npm run build`로 생성된 정적 파일(`build/`)만 Nginx 이미지로 복사하여 서빙.

## 2. 이미지 최적화 전략 (Best Practices)

### 1) 경량 베이스 이미지 사용
*   `ubuntu` 같은 범용 OS 대신 `alpine` (5MB 수준), `slim`, `distroless` 이미지 사용 권장.

### 2) 레이어 최소화
*   `RUN` 명령어를 `&&` 연결자(Chain)로 묶어서 실행.
    *   Bad:
        ```dockerfile
        RUN apt-get update
        RUN apt-get install -y vim
        ```
    *   Good:
        ```dockerfile
        RUN apt-get update && apt-get install -y vim \
            && rm -rf /var/lib/apt/lists/*
        ```
    *   apt 캐시 삭제(`rm -rf ...`)를 통해 불필요한 파일 제거.

### 3) .dockerignore 활용
*   불필요한 파일(소스 관리 파일, 로컬 테스트 파일 등)이 컨텍스트에 포함되지 않도록 설정.

### 4) Caching 활용
*   변경이 적은 부분(라이브러리 설치 등)을 Dockerfile 상단에 배치.
*   소스 코드(`COPY . .`)는 변경이 잦으므로 가능한 하단에 배치.
    *   (예: `package.json` 먼저 COPY 후 `npm install`, 그 뒤에 소스 COPY)

## 3. Docker Compose 상세

### 1) 개요
*   여러 개의 컨테이너(Multi-Container) 애플리케이션을 정의하고 실행하기 위한 도구.
*   YAML 파일(`docker-compose.yml`)에 서비스, 네트워크, 볼륨 등을 정의.

### 2) 명령어
*   `docker-compose up`: 서비스 생성 및 시작 (이미지 빌드/풀 포함).
    *   `-d`: 백그라운드 실행.
    *   `--build`: 이미지 강제 재빌드.
*   `docker-compose down`: 서비스 정지 및 컨테이너/네트워크 삭제.
    *   `-v`: 볼륨까지 삭제.
*   `docker-compose ps`: 서비스 상태 확인.
*   `docker-compose logs -f`: 로그 확인.

### 3) 구성 요소 (`docker-compose.yml`)
*   **version**: 파일 규격 버전 (예: '3').
*   **services**: 실행할 컨테이너 정의.
    *   `image`: 사용할 이미지.
    *   `build`: 빌드할 Dockerfile 경로.
    *   `ports`: 포트 포워딩.
    *   `environment`: 환경 변수.
    *   `volumes`: 볼륨 마운트.
    *   `depends_on`: 실행 순서 지정 (예: db가 먼저 켜져야 web 실행).
*   **networks**: 네트워크 정의.
*   **volumes**: 볼륨 정의.

### 4) 예제: Web + Redis
```yaml
version: '3'
services:
  web:
    build: .
    ports:
      - "5000:5000"
    depends_on:
      - redis
  redis:
    image: "redis:alpine"
```
